generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "sqlite"
}

enum UserType {
  APP_ADMIN
  SUPER_ADMIN
}

enum CallStatus {
  ACTIVE
  COMPLETED
  FAILED
}

enum ReservationStatus {
  WAITING
  WAITING_CUSTOMER
  CONFIRMED
  CANCELED
  REFUSED
  ARRIVED
  SEATED
  OVER
  NO_SHOWN
}

enum ItemType {
  DRINK
  APPETIZER
  MAIN_COURSE
  DESSERT
  SIDE
  SALAD
}

model Restaurant {
  id                   String  @id @default(uuid())
  name                 String
  isActive             Boolean @default(true)
  incomingPhoneNumber  String
  maxEscalationSeating Int     @default(12)

  zenchefId String @unique
  apiToken  String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  menus           Menu[]
  customers       Customer[]
  seatingAreas    SeatingArea[]
  calls           Call[]
  authentications RestaurantAuthentication[]
  reservations    Reservation[]

  @@index([incomingPhoneNumber])
}

model RestaurantAuthentication {
  id           String  @id @default(uuid())
  clientId     String  @unique
  clientSecret String // Hashed secret, never exposed after creation
  isActive     Boolean @default(true)

  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([restaurantId])
  @@index([clientId])
}

model SeatingArea {
  id            String  @id @default(uuid())
  name          String
  description   String?
  maxCapacity   Int
  zenchefRoomId Int

  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])

  @@unique([restaurantId, zenchefRoomId])
  @@index([restaurantId])
}

model Menu {
  id          String  @id @default(uuid())
  isActive    Boolean @default(true)
  description String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  menuItems    MenuItem[]

  @@index([restaurantId, isActive])
}

model MenuItem {
  id   String   @id @default(uuid())
  type ItemType
  name String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  menuId String
  menu   Menu   @relation(fields: [menuId], references: [id])

  @@unique([menuId, type, name])
  @@index([menuId, name])
  @@index([menuId])
}

model Customer {
  id    String  @id @default(uuid())
  name  String
  email String?
  phone String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  calls        Call[]

  @@unique([restaurantId, email])
  @@unique([restaurantId, phone])
  @@index([restaurantId, name])
}

model Call {
  id                  String     @id @default(uuid())
  status              CallStatus @default(ACTIVE)
  startTime           DateTime   @default(now())
  endTime             DateTime?
  duration            Int? // in seconds
  transcript          String?
  language            String?
  escalationRequested Boolean    @default(false)

  customerId           String?
  customer             Customer?  @relation(fields: [customerId], references: [id])
  restaurantId         String
  restaurant           Restaurant @relation(fields: [restaurantId], references: [id])
  zenchefReservationId String? // External Zenchef booking ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([restaurantId])
  @@index([customerId])
  @@index([status])
  @@index([startTime])
}

model Reservation {
  id               String            @id @default(uuid())
  zenchefBookingId String
  status           ReservationStatus @default(WAITING)
  date             String // YYYY-MM-DD format
  time             String // HH:MM format
  numberOfGuests   Int
  customerName     String
  customerPhone    String?
  customerEmail    String?
  comments         String?
  allergies        String?
  seatingAreaName  String?

  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([restaurantId, zenchefBookingId])
  @@index([restaurantId])
  @@index([restaurantId, date])
  @@index([status])
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  name         String
  passwordHash String
  type         UserType
  isActive     Boolean  @default(true)

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}
